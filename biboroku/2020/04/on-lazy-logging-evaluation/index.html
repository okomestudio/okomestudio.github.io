<!doctype html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-158896843-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-158896843-1');
    </script>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){
        w[l]=w[l]||[];w[l].push(
          {'gtm.start':
           new Date().getTime(),event:'gtm.js'}
        );var f=d.getElementsByTagName(s)[0],
              j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-NXBHQLG');
    </script>
    <!-- End Google Tag Manager -->

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Okome Studio is a software consultancy">
    <link rel="icon" href="https://okomestudio.net/favicon.ico">
    <link rel="stylesheet" href="https://okomestudio.net/reset.css">
    <link rel="stylesheet" href="https://okomestudio.net/index.css">
    <link rel="stylesheet" href="../../../static/style.css">
    <link rel="stylesheet" href="../../../static/pygments.css">
    <link rel="stylesheet" href="../../../static/gist.css">
    <title>On Lazy Logging Evaluation — biboroku</title>
    <script type="text/javascript">
      window.MathJax = {
        tex: {
          tags: 'ams'
        }
      };
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });
    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML">
    </script>

    <script type="text/javascript" src="static/pjump.js"></script>

  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBHQLG"
              height="0" width="0" style="display:none;visibility:hidden">
      </iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
      <header>
        <h1><a href="https://okomestudio.net/biboroku">biboroku</a></h1>
        <nav>
          <ul class="nav navbar-nav">
            <li><a href="https://okomestudio.net">OkomeStudio.net</a></li>
            
            <li><a href="../../../about/">About</a></li>
            
          </ul>
        </nav>
      </header>
      <main>
        
  
  <div class="blog-post">
  
    <h1>On Lazy Logging Evaluation</h1>
  
  <p class="meta">
    Written by
    
      Taro Sato
    
    on 2020-04-14
  </p>
  
  <p>The stdlib <code>logging</code> package in Python encourages the C-style message
format string and passing variables as arguments to its log
method. For example,</p>
<div class="hll"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result x = </span><span class="si">%d</span><span class="s2">, y = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>  <span class="c1"># Bad</span>
<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result x = </span><span class="si">%d</span><span class="s2">, y = </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>     <span class="c1"># Good</span>
</pre></div>
<p>or</p>
<div class="hll"><pre><span></span><span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result x = </span><span class="si">%(x)d</span><span class="s2">, y = </span><span class="si">%(y)d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>  <span class="c1"># Bad</span>
<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result x = </span><span class="si">%(x)d</span><span class="s2">, y = </span><span class="si">%(y)d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>   <span class="c1"># Good</span>
</pre></div>
<p>As the message does not need to be formatted when the logging level is
set higher than the value set for the logger, we would waste time
formatting the string in the “bad” cases above, when the message does
not get logged at all. The “good” cases avoid this by deferring
formatting until the logger finds it necessary.</p>
<p>Sometimes, though, we may want to log debug message with values that
are expensive to compute. For example, in the above example, what if
<code>y</code> depends on <code>x</code>, and the function that does the computation, e.g.,</p>
<div class="hll"><pre><span></span><span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">expensive</span> <span class="n">computation</span> <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
<p>is rather expensive? If this is done only for the purpose of the debug
message, that would be a wasteful computation when the logging level
is higher than the value at which the result is logged at.</p>
<h2>Lazy Function Evaluation with <code>logging</code></h2>
<p>Fortunately, it is easy to add lazy evaluation of function using a
custom <code>dict</code> and <code>functools.partial</code>.</p>
<div class="hll"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserDict</span>


<span class="k">class</span> <span class="nc">Args</span><span class="p">(</span><span class="n">UserDict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">get_y</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="o">...</span> <span class="n">expensive</span> <span class="n">computation</span> <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result x = </span><span class="si">%(x)d</span><span class="s2">, y = </span><span class="si">%(y)d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">Args</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">get_y</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
</pre></div>
<p>The idea is to use <code>partial</code> to defer the execution of function,<sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup>
and store it in a <code>dict</code>-like object that is aware of the need to call
the function on access through the key.</p>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>This is not a typical use of <code>partial</code>, but is a perfectly fine
way of using the function.<a href="#fnref-1" class="footnote">&#8617;</a></p></li>
</ol>
</div>

  
  </div>

  
  <div class="comments">
<div id="disqus_thread"></div>
<script>
  var disqus_config = function() { this.page.identifier = "/2004-on-lazy-logging-evaluation"; };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//biboroku.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>
  Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript"
    rel="nofollow">comments powered by Disqus.</a>
</noscript>
</div>
  


      </main>
      <footer>
        Copyright &copy; 2007 - 2020 by Okome Studio / Taro Sato. All Rights Reserved.
      </footer>
    </div>
  </body>
</html>
